## 数据设计

### 书籍用什么存储？

初步的想法是用文件存储，但是为了方便读写，书籍按照章节分开，每章单独存储。每章做成一个压缩文件，前缀是章节ID

### 压缩格式

暂时用zip格式，今后需要专门研究一下，找一个读写速度和磁盘空间综合起来效果最好的格式。

### 目录设计

为了避免一个文件夹中有太多子文件，我们需要把所有的书籍分到多层目录中存放。现在暂时设计成3层：

- 第一层，书籍ID的前3个字符，如`AAA`，因为书籍都是`A`开头的，所以这一层目录有`64*64=4096`个。
- 第二层，书籍ID，即每一本书一个目录
- 第三层，本书各章节的压缩文件，以及一个目录文件toc.txt（注：目录也可以从数据库中读取）

假设存储磁盘目录是`/data/book/`，那么目录结构大致如下：

```
/data/book/
    AAA/
        AAA4_lz1K3L/
            BB219z7-LDn.zip
            BAdfjqo103j.zip
            BdfkIAm1l29.zip
            ...
        AAAqerj120_/
            Bafkq1023kz.zip
            Bqal13T218n.zip
            ...
    AAB/
        AABjq19_-13/
            Bsad1923nnz.zip
            ...
    ...
```

### ID设计

书籍、作者、章节的ID，都用Base64的10位随机码。

这个码的第一个字节，表示数据类型，如书籍是`A`，章节是`B`，作者是`C`，等等。这样一共可以支持64种数据类型，理论上应该够NeoReads使用了。

剩下9个字节，每个字节64种可能性，一共有64^9种可能性，即18014398509481984（1.80e16）种可能，基本够用了。

NeoReads的Base64，采用类URLSafe格式即使用如下的字符集：
- 数字字符：0至9
- 小写字母：a至z
- 大写字母：A至Z
- 最后两个字符：`-`和`_`

示例：
- 一本书：`AcD4_lz1K3L`
- 一个章节：`BB219z7-LDn`
- 一位作者：`Ccccccccccc`

### 句子怎么存储

NeoReads的核心数据是句子以及句子组成的句集。那应该如何存储句子呢？

本来我打算用句子在章节中的位置来定位，而不需要单独存储，但这样至少有两个缺点：

- 如果章节改变，章节内的所有句子的定位，都需要重新更新。
- 现在既然改成了压缩文件，定位就没法直接用了。在压缩文件场景下，要读取一个句子，得先临时解压缩，再读取句子，再删除压缩文件，这显然太浪费了。
  
因此，应该单独存储句子的内容。但这也带来了一个问题：

- 如果章节内容修改，需要找到对应的句子，修改其单独存储的内容。

两相权衡，暂时还是选择第二个方案。等做出来了再实际体验。

在这个方案下，为了节省空间，只有被注意到的句子，如做过笔记、标过重点的句子，才会被单独存储。普通的句子仍然只是章节中的一部分而已。这样，一个句子应该包含如下信息：

- 句子ID
- 内容
- 章节大致定位（比如第几句）

这样，句子就可以用在笔记、评注，以及背句子的功能中了。

为了保证句子的独立性，并不直接存储章节ID，而是另外用一个关联表关联。这样，一个句子就可以属于多个不同的书籍。比如，“白日依山尽，黄河入海流”显然会出现在很多书籍中。

### 句子查重

不过这么做的话，就要求我们在记录句子的时候，要进行查重合并。比如用户读到“白日依山尽，黄河入海流”这句，并划了高亮。此时系统应当把这句话返回给服务器，服务器通过文本检索反查到数据库中对应的句子ID，再返回给客户端；如果查不到，再新建一个ID，返回给客户端。

初步看，这样做似乎没问题，但是显然给服务器增加了计算负担，还得更仔细考虑下。

### 包含多个句子的笔记如何存储

笔记可以做成单独的概念，对应一个到多个句子。

### 笔记、高亮、评注等概念，在数据库中怎么存。

